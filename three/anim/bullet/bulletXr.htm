<!DOCTYPE html>
<html lang="en">
<head>
<title>bulletXr</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>body { color:#000;background-color:#aaa;margin:0px;overflow:hidden;font-family:Sans-serif; }</style>
<script src="/conet.js"></script>
<script src="/menu.js"></script>
<script src="/sound.js"></script>
<script src="/vecmath.js"></script>
<script src="/canvas/pd5.js"></script>
<script src="/three/threePd5.js"></script>
<script src="/bulletjs/bullet.js"></script>
<script src="/bulletjs/panim.js"></script>
</head>
<body>
<script type="importmap">
{
"imports": {
"three": "/three/r160/build/three.module.js",
"three/addons/": "/three/r160/examples/jsm/"
}
}
</script>
<script type="module">
import * as THREE from '/three/r160/build/three.module.js';
import { OrbitControls } from '/three/r160/examples/jsm/controls/OrbitControls.js';
import { XrUtil } from '/util/gfx/XrUtil.js';
(function() {
  //---
  const clock=new THREE.Clock(),xrUtil=XrUtil;
  let container,camera,scene,raycaster,renderer,
      room,INTERSECTED,controls,o0,panim,
      cursorBox0,cursorBox1;
  
  init();
  animate();
  
  function init() {
    
    //script src="/util/bricks.js">/script>
    
    
    container = document.createElement( 'div' );
    document.body.appendChild( container );
    
    scene = new THREE.Scene();
    scene.background = new THREE.Color( 0x505050 );
    
    camera=new THREE.PerspectiveCamera(50,window.innerWidth/window.innerHeight,0.1,100);
    camera.position.set(0,1.6,3);
    scene.add(camera);
    //console.log(camera);
    
    //import { BoxLineGeometry } from '/three/r124/examples/jsm/geometries/BoxLineGeometry.js';
    //
    //room=new THREE.LineSegments(
    //  new BoxLineGeometry(6,6,6,10,10,10).translate(0,3,0),
    //  new THREE.LineBasicMaterial({color:0x808080}));
    room=new THREE.Group();scene.add(room);
    room.scale.set(0.5,0.5,0.5);
    //room=scene;
    
    //scene.add(new THREE.AmbientLight(0xffffff,0.5));//new THREE.HemisphereLight(0x606060,0x404040));
    //const light = new THREE.DirectionalLight(0xffffff);
    //light.position.set(0.5,1,0.25).normalize();
    //scene.add(light);
    
    window.THREE=THREE;
    scene.add(new THREE.AmbientLight(0xffffff,0.3));
    scene.add(threeEnv.pointLight({x:-4,y:12,z:4,col:0xffffff,dist:25,int:2*200}));
    scene.add(threeEnv.pointLight({x:5,y:-5,z:-5,col:0xaaffff,dist:100,int:0.5*200,castShadow:false}));
    
    
    //const geometry = new THREE.BoxBufferGeometry( 0.15, 0.15, 0.15 );
    
    raycaster = new THREE.Raycaster();
    
    renderer = new THREE.WebGLRenderer( { antialias: true } );
    renderer.setPixelRatio( window.devicePixelRatio );
    renderer.setSize( window.innerWidth, window.innerHeight );
    //renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.shadowMap.enabled=true;
    renderer.shadowMap.type=THREE.BasicShadowMap;
    renderer.xr.enabled = true;
    container.appendChild( renderer.domElement );
    
    controls=new OrbitControls(camera,renderer.domElement);
    //
    
    xrUtil.init({scene:scene,renderer:renderer,camera:camera,room:room
      //,XRControllerModelFactory:XRControllerModelFactory
      });
    xrUtil.initHud();
    xrUtil.hud.buttons=[
    
    {s:'panHit',x:0.5,y:0.7,w:0.45,h:0.25,ondown:function() {
      //---
      let o=panim.stick15o;
      panim.start(o,o.o.panHit);
      //...
    }
    }
    
    ];
    xrUtil.log('BulletXr v.0.20 ');//FOLDORUPDATEVERSION
    
    
    window.addEventListener('resize',onWindowResize,false);
    //
    
    //document.body.appendChild(VRButton.createButton(renderer));
    
    window.THREE=THREE;
    threeEnv.base=room;//room;//scene;
    threeEnv.scene=room;
    threeEnv.path='/shooter/';
    threeEnv.coBoSp=1;//computeBoundingSphere
    threeEnv.camera=camera;
    threeEnv.aipos=1;
    if (0)
    Conet.download({fn:'/shooter/objs/templar/o5.txt',f:function(v) {
      //---
      var o=Pd5.load(v);
      o.scale=1;
      Pd5.animStart(o,'stand2');
      threeAddObj(o,0,0,0,3);
      //...
    }
    });
    
    Menu.init([{s:'&#9776;',noTri:true,fs:1.4,pw:0.05,sub:[
      Menu.mFullscreen
      ]},xrUtil.menuXr
    
    ,{s:'panHit',actionf:function() {
      //---
      let o=panim.stick15o;
      panim.start(o,o.o.panHit);
      //onsole.log(panim.stick15o);
      //...
    }
    }
    
      ]
      ,{listen:1});
    
    //Bricks.initLoader({scene:room,scale:0.01,pos:{x:5,y:2,z:0}});
    //Conet.download({fn:'/three/lego/moreColors.txt',f:Bricks.parseLoad});
    
    // /three/anim/voxed/nienhagen1monster.json
    const tsd=Menu.touchSticksInit({autoKeys:1,skip1:1});
    
    
    {
    const mb=125;
    Pd5.boxes.push([-mb,10,0,10,20,mb]);
    Pd5.boxes.push([mb,10,0,10,20,mb]);
    Pd5.boxes.push([0,10,-mb,mb,20,10]);
    Pd5.boxes.push([0,10,10+mb,mb,20,10]);
    
    Pd5.boxes.push([-75,0,-75,50,10,50]);//,0.09]);
    Pd5.boxes.push([0,0,-35,10,10,10]);//,0.09]);
    Pd5.boxes.push([-90,15,-50,25,5,25]);
    
    //Pd5.boxes.push([0,20,35,2,2,2]);//,0.09]);
    
    var ge=new THREE.BufferGeometry(),w=mb/7,c=new THREE.Color(0.5,0.5,0.5),y0=-1.8,h0=w/3;
    
    for (var i=Pd5.boxes.length-1;i>=0;i--) { var b=Pd5.boxes[i];
      var x=b[0],y=b[1],z=b[2],dx=b[3]*2,dy=b[4]*2,dz=b[5]*2,d=13;
      //onsole.log(b);
      x/=d;y/=d;z/=d;dx/=d;dy/=d;dz/=d;
      threeEnv.addQuad({ge:ge,a0:[x-dx/2,y-dy/2-1.8,z+dz/2],a1:[0,0,-dz],a2:[dx,0,0],a3:[dx,0,-dz],dim:1,c:c});
      threeEnv.addQuad({ge:ge,a0:[x-dx/2,y+dy/2-1.8,z+dz/2],a1:[dx,0,0],a2:[0,0,-dz],a3:[dx,0,-dz],dim:1,c:c});
      threeEnv.addQuad({ge:ge,a0:[x-dx/2,y-dy/2-1.8,z+dz/2],a1:[dx,0,0],a2:[0,dy,0],a3:[dx,dy,0],dim:1,c:c});
      threeEnv.addQuad({ge:ge,a0:[x-dx/2,y-dy/2-1.8,z+dz/2],a1:[0,dy,0],a2:[0,0,-dz],a3:[0,dy,-dz],dim:1,c:c});
      threeEnv.addQuad({ge:ge,a0:[x-dx/2,y-dy/2-1.8,z-dz/2],a1:[0,dy,0],a2:[dx,0,0],a3:[dx,dy,0],dim:1,c:c});
      threeEnv.addQuad({ge:ge,a0:[x+dx/2,y-dy/2-1.8,z+dz/2],a1:[0,0,-dz],a2:[0,dy,0],a3:[0,dy,-dz],dim:1,c:c});
    }
    
    ge.setIndex(ge.indices);
    ge.setAttribute('position',new THREE.BufferAttribute(new Float32Array(ge.vertices),3));
    ge.setAttribute('color',new THREE.BufferAttribute(new Float32Array(ge.colors),3));
    
    
    
    if (1) {
    Menu.onMouseMove=function (e) {
      //---
      if (xrUtil.isSession) return;
      checkCreateCursorBoxes();
      let p=cursorBox0.position;
      p.set((e.pageX-window.innerWidth/2)/100,-0.5,(e.pageY-window.innerHeight/2)/100);
      //console.log(Pd5.boxes.length);
      let origin=cursorBox0.userData.body.worldTransform.origin;
      origin.x=p.x*13;
      origin.y=(p.y+1.8)*13;
      origin.z=p.z*13;
      //onsole.log(Pd5.boxes[8].body.worldTransform.origin);
      
      //var colObj=dynamicsWorld.collisionObjects[oi];
      //var t=new Bullet.Transform();
      //t.setIdentity();
      //t.origin.set3(0,y0,0);
      //colObj.setWorldTransform(t);
      //Bullet.RigidBody.upcast(colObj).setActivationState(Bullet.CollisionObject.DISABLE_DEACTIVATION);
      
      
      
      //...
    }
    
    }
    
    
    
    ge.computeVertexNormals();
    var bge=ge;//new THREE.BufferGeometry().fromGeometry(ge);
    var mh={vertexColors:true};//THREE.FaceColors};
    var m=new THREE.Mesh(bge,new THREE.MeshPhongMaterial(mh));
    m.position.set(0,0,0);
    m.castShadow=true;
    m.receiveShadow=true;
    let cont=room;//scene;//room
    cont.add(m);//room
    
    const a=[];
    const fn=
      //'/shooter/objs/bullet/bird/o.json';
      '/shooter/objs/bullet/stick15.txt';
    
    panim=new Panim({});
    
    
    (o0=panim.obj(0,-1,{
      fn:fn,panOnload:panim.onload
    }));panim.stick15o=o0;
    //a.push(o0);panos.push(o0);
    
        
    (o0=panim.obj(5,-2,{
      fn:fn,diff:'/shooter/objs/bullet/stick15/skin1d.json'
      
    ,onload:function(o) {
      //---
      for (const w of o.bones[3].ws) w.p0.y/=2;
      for (const w of o.bones[2].ws) w.p0.y/=2;
      for (const w of o.bones[4].ws) w.p0.y/=2;
      for (const w of o.bones[5].ws) w.p0.y/=2;
      for (const w of o.bones[6].ws) w.p0.y*=2;
      panim.objOnload(o);
      //...
    }
      
      ,panOnload:panim.onload
    }));o0.panai=1;
    //a.push(o0);panos.push(o0);
    
    
    (o0=panim.obj(-5,-2,{
      fn:fn,diff:'/shooter/objs/bullet/stick15/skin1d.json',panOnload:panim.onload
    }));o0.panai=1;
    //a.push(o0);panos.push(o0);
    
    //--- now do loadObjsThenLoop(a)
    for (const h of panim.a) {
    h.f=function(v) {
      //---
      let ps=this;
      var o=Pd5.load(v);
      //---loadinit start
      o.ps=ps;ps.o=o;
      
      if (ps.roty===undefined) ps.roty=0;
      
      if (ps.onload) ps.onload(o);
      
      //---loadinit end
      o.scale=1;
      Pd5.animStart(o,'idle');
      
      //Pd5.calc(o,0,0.0,0,1,{x:0,y:0,z:0},0,0,true);
      
      threeAddObj(o,0,0,0,1*ps.scale);
      //...
    }
      Conet.download(h);
    }
    
    //panim.panos=panos;panim.a=a;
    panim.xrUtil=xrUtil;panim.camera=camera;
    panim.tsd0=tsd[0];
    panim.controls=controls;
    }
    //---
  }
  function onWindowResize() {
    //...
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize( window.innerWidth, window.innerHeight );
    //---
  }
  function animate() {
    
    renderer.setAnimationLoop( render );
    
  }
  
  function checkCreateCursorBoxes() {
    //---
    if (!cursorBox0) { 
      let g=new THREE.BoxGeometry(0.35,0.35,0.35),
          mat=new THREE.MeshPhongMaterial({flatShading:true,color:0x66aa66//,depthTest:false
          ,transparent:true,opacity:0.7}),
          mesh=new THREE.Mesh(g,mat);//,p=mesh.position;
      room.add(mesh);cursorBox0=mesh;
      cursorBox0.userData.body=Pd5.bulletBox([0,20,35,2,2,2]);
      
      cursorBox1=new THREE.Mesh(g,mat);room.add(cursorBox1);
      cursorBox1.userData.body=Pd5.bulletBox([0,20,35,2,2,2]);
    }
    //...
  }
  
  function render() {
    
    //const cgd=clock.getDelta(),delta=cgd*60,dt=cgd*1000;
    const dt=clock.getDelta()*1000;
    
    const ctrl0=xrUtil.ctrl0;//controller
    const ctrl1=xrUtil.ctrl1;
    const gp0=xrUtil.gp0;
    const gp1=xrUtil.gp1;
    
    xrUtil.checkFlight(dt);
    
    if (xrUtil.isSession) {
      //onsole.log(ctrl0.position);
      checkCreateCursorBoxes();
      let pr=room.position,sc=room.scale;
      {
      let p=cursorBox0.position;
      let pc=ctrl0.position;
      p.set((pc.x-pr.x)/sc.x,(pc.y-pr.y)/sc.y,(pc.z-pr.z)/sc.z);
      //p.copy(ctrl0.position);//set((e.pageX-window.innerWidth/2)/100,-0.5,(e.pageY-window.innerHeight/2)/100);
      //console.log(Pd5.boxes.length);
      //let origin=Pd5.boxes[8].body.worldTransform.origin;
      let origin=cursorBox0.userData.body.worldTransform.origin;
      origin.x=p.x*13;
      origin.y=(p.y+1.8)*13;
      origin.z=p.z*13;
      }
      {
      let p=cursorBox1.position;
      let pc=ctrl1.position;
      p.set((pc.x-pr.x)/sc.x,(pc.y-pr.y)/sc.y,(pc.z-pr.z)/sc.z);
      let origin=cursorBox1.userData.body.worldTransform.origin;
      origin.x=p.x*13;
      origin.y=(p.y+1.8)*13;
      origin.z=p.z*13;
      }
    }
    
    if (gp1) {
      //panim.gpad=gp1;
      //room.position.x-=gp1.axes[2]*dt*0.1;
      //room.position.y+=gp1.axes[3]*dt*0.1;
    }
    
    //if (window.panimCalc) 
    panim.calc(dt);
    
    if (Pd5.dynamicsWorld) Pd5.dynamicsWorld.stepSimulation1(dt/1000);
    
    threeRender(dt);
    controls.update();
    xrUtil.renderHud();
    
    renderer.render(scene,camera);
    //...
  }
  //...
}
)();

</script>
</body>
</html><script>
//fr o,29
//fr o,29,9
//fr o,29,9,57
//fr o,29,9,77
//fr o,29,9,84
//fr o,29,9,131
//fr o,29,9,164
//fr o,29,9,178
//fr o,29,13
//fr o,29,15
//fr p,77,72
