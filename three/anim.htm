<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<link rel="shortcut icon" sizes="128x128" href="/blog/alster2.jpg">
<link rel="apple-touch-icon" href="/blog/alster2.jpg">
<style>
body { color:#000;background-color:#aaa;margin:0px;overflow:hidden;font-family:Sans-serif; }
</style>
<script src="https://threejs.org/build/three.js"></script>
<script src="https://threejs.org/examples/js/vr/WebVR.js"></script>
<script src="https://threejs.org/examples/js/libs/stats.min.js"></script>
<script src="/three/v81/OrbitControls.js"></script>
<script src="/menu.js"></script>
<script src="/conet.js"></script>
<script src="/sound.js"></script>
<script src="../vecmath.js"></script>
<script src="../canvas/pd5.js"></script>
<script src="threePd5.js"></script>
<script src="/bulletjs/bullet.js"></script>
</head><body oncontextmenu="return false;">
<div id="container"></div>
<script>
function Planim() {
  //! https://threejs.org/examples/js/controls/OrbitControls.js
  //!   stopped using this, since 27.3.2018 it has event.preventDefault in
  //!   touchStart which disables clickevents
  var scene,stats,views=[],oh={},ot=Date.now(),scra=[],scri=0,scrt=0,loopAfterLoaded,
      base,debug='',version='1.1637 ',//FOLDORUPDATEVERSION
      m0=new THREE.MeshPhongMaterial( { color:0x666666,flatShading:true } ),
      m1=new THREE.MeshPhongMaterial({color:0x77dd77,flatShading:true,
      transparent:true,opacity:0.5}),mray0=new THREE.MeshPhongMaterial({
      color:0x66aa66,flatShading:true}),keys=[],url,click=undefined,
      raycaster=new THREE.Raycaster(),anchors={},canch,aa={c0:new THREE.Vector3(),
      c1:new THREE.Vector3(),t0:new THREE.Vector3(),t1:new THREE.Vector3()},taa=0,
      tam=500,eclick,game={},PI=Math.PI,skipClick=false,raret=0,vrdevice=undefined,
      self=this,record,recording=false,viewing=false,vq0=new THREE.Quaternion(),
      vq1=new THREE.Quaternion(),ray0,fetch,fetchop=new THREE.Vector3(),camkt=0,
      fetchbp=new THREE.Vector3(),camv=0,cmenu,menui=0,rvr,vrd,vrUserHeight=0,
      mh0=new THREE.Matrix4(),ot=Date.now(),dtscale=1,
      egoi=-1,vh0=new THREE.Vector3(),vdef=0.001,vrbu,baseRot={x:0.3,y:0,z:0},
      tIsoStrafe=0,uiMode=-1,mD=false,inp={x:0,y:0},controls,pts=[],pts2=[];
  function updateHud(view) {
    if (!view) view=views[0];
    var hud=view.hud,c=hud.c,ct=c.getContext('2d'),w=c.width,h=c.height;
    ct.clearRect(0,0,w,h);
    ct.fillStyle='rgba(150,150,150,0.3)';ct.fillRect(0,0,w,h);
    ct.fillStyle='#000';ct.font='10px sans-serif';ct.textBaseline='top';
    if (view.hudRender) 
      view.hudRender(ct);
    else 
      ct.fillText('v.'+version+debug,2,2);
    hud.t.needsUpdate=true;
    //...
  }
  function addView(v) {
    var camera,renderer;
    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setClearColor(v.bgcol!==undefined?v.bgcol:0x888888);
    renderer.shadowMap.enabled=true;
    renderer.shadowMap.type=THREE.BasicShadowMap;
    //				renderer.shadowMapEnabled=true;
    //				renderer.shadowMapType=THREE.PCFShadowMap;//PCFShadowMap;
    
    //! without following vr mode is too blurry
    renderer.setPixelRatio(window.devicePixelRatio);
    
    //renderer.setSize( window.innerWidth, window.innerHeight );
    
    var container = document.getElementById('container'),ms=[];
    var c=renderer.domElement,s=c.style;//s.textAlign='center';
    if (v.bw) {
      s.borderStyle='solid';s.borderWidth=v.bw;
    }
    container.appendChild(c);
    
    camera=new THREE.PerspectiveCamera(v.fov||60,window.innerWidth/window.innerHeight,v.camNear||0.01,v.camFar||100);//1,1000
    //camera.position.z=v.camz||500;
    //camera.position.x=v.camx||0;
    
    if (v.cam&&!v.vr) camera.position.copy(v.cam); //else camera.position.set(0,0,0);
    
    //camera.position.set(v.camx||0,v.camy||0,v.camz||500);
    //camera.rotation.y=0.5;
    //camera.rotation.x=0.2;
    camera.rotation.order='YXZ';
    scene.add(camera);
    
    if (!v.vr&&!v.noOrbitControls) {
      controls=new THREE.OrbitControls(camera,renderer.domElement);
      controls.enableDamping=true;
      controls.dampingFactor=0.25;
      if (v.autoRotate) controls.autoRotate=true;
      controls.enableZoom=true;
      controls.enablePan=true;
      controls.maxDistance=v.orbitMaxDist||600;
      controls.rotateSpeed=0.4;
      controls.enableKeys=false;
      controls.zoomSpeed=v.zoomSpeed||0.5;
      if (v.target) controls.target.copy(v.target);
    }
    //controls.rotateLeft(0.5);
    v.renderer=renderer;v.camera=camera;v.controls=controls;
    
    if (!v.bg) {
      var c=document.createElement('div'),s=c.style;
      s.backgroundColor='rgba(255,255,255,0.8)';s.zIndex=100;s.position='absolute';s.textAlign='center';s.padding='2px';
      c.innerHTML='Hello World.';s.fontFamily='Arial';s.borderStyle='solid';s.display='none';
      v.textc=c;
      container.appendChild(c);
    }
    
    views.push(v);
    
    
    if (v.vr) {//||v.noOrbitControls) {
      //renderer.vr.enabled=true;
    
    if (!v.noHud) {
      var c=document.createElement('canvas'),w=v.hudres||128,
          h=w;c.width=w;c.height=h;
      var t=new THREE.Texture(c);v.hud={c:c,t:t};
      
      //var ct=c.getContext('2d');ct.fillStyle='rgba(150,150,150,0.3)';ct.fillRect(0,0,w,h);
      //ct.fillStyle='#000';ct.font='10px sans-serif';ct.textBaseline='top';ct.fillText('v.'+version,2,2);
      //t.needsUpdate=true;
      updateHud(v);
    
      //if (!v.noHud) {
      var ar=v.hudar||0.11,g=new THREE.PlaneGeometry(0.1,0.1*ar);
      g.faceVertexUvs=[[[{x:0,y:1},{x:0,y:1-ar},{x:1,y:1}],[{x:0,y:1-ar},{x:1,y:1-ar},{x:1,y:1}]]];
      var crosshair = new THREE.Mesh(g,
        new THREE.MeshBasicMaterial({color:0xffffff,
          map:t,
          opacity:1,transparent:true}));
      //crosshair.position.z=-0.3;
      crosshair.position.set(v.hudx||0.05,v.hudy||-0.05,v.hudz||-0.3);
      camera.add(crosshair);
    }
    }
    
    if (v.vr) {
    
      if (1) initVr(); else 
      if (0) { //for now dont using this, but init-vr-menu
    var c=document.createElement('button'),s=c.style;
    c.innerHTML='Init VR';
    c.onclick=function() {
      document.body.removeChild(c);
      initVr();
    }
    s.position='absolute';
    s.left='calc(50% - 50px)';
    s.bottom='20px';s.width='100px';
    s.cursor='pointer';
    
    s.padding = '12px 6px';
    s.border = '1px solid #fff';
    s.borderRadius = '4px';
    s.background = 'rgba(0,0,0,0.1)';
    s.color = '#fff';
    s.font = 'normal 13px sans-serif';
    s.textAlign = 'center';
    s.opacity = '0.5';
    s.outline = 'none';
    s.zIndex = '999';
    
    document.body.appendChild(c);vrbu=c;
      }
      //var b=WEBVR.createButton(renderer);
      //document.body.appendChild(b);
      //var rvr=renderer.vr;
      //if (rvr.getDevice()) base.position.set(0,rvr.userHeight,0);
    }
    
    
    //views.push(v);
    
    if (v.bg) {
      threeEnv.camera=camera;
      renderer.setAnimationLoop(animate); //before v93: renderer.animate(animate);
    }
    return v;
  }
  function box(x,y,z,w,h,b,m) {
    if (!m) m=m0;
    mesh=new THREE.Mesh(new THREE.BoxBufferGeometry(w,h,b),m);
    mesh.position.set(x,y,z);
    mesh.updateMatrix();
    mesh.matrixAutoUpdate=false;
    mesh.castShadow=true;
    mesh.receiveShadow=true;
    base.add(mesh);
    return mesh;
  }
  function resize() {
    var gw=window.innerWidth,gh=window.innerHeight,gmin=Math.min(gw,gh),w,h,
        maxa=1.5,gmax=Math.max(gw,gh),ah=1.75//1.75
        ,f=Math.min(ah,gmax/gmin),minf=0.5;//0.5
    
    //onsole.log('anim.resize gw='+gw+', gh='+gh);
    
    //f=(1-(ah-f));
    //gmin*=minf+f*(1-minf);
    if (views.length==0) return;
    
    if (views.length==3) {
      var v0=views[0],mih,mah;//ah=gw/gh;
      //viewText(2,
      if (gw>gh) { mih=1.5;mah=2; } else { mih=1.5,mah=1.8; }
      var f0=Math.max(mih,Math.min(mah,gmax/gmin));f0=(f0-mih)/(mah-mih);
      //viewText(2,''+f0);
      var z=0.80*(1-f0)-0.30;//((ah>2)||(ah<0.5))?-20:50;
      v0.controls.target.z=z;//50*(1-f);
      v0.camera.position.z=z;//50*(1-f);
    }
    
    f=(1-(ah-f));
    gmin*=minf+f*(1-minf);
    
    
    for (var i=views.length-1;i>=0;i--) {
      var v=views[i],camera=v.camera,renderer=v.renderer,
          s=renderer.domElement.style;
      if (v.bg) {
        w=gw*v.w,h=gh*v.h;
        if (views.length==3) {
          if (w/h<1) {
            s.top=(h-w)*1+'px';//0.8
            h=w;
          } else s.top='0px';
          if (w/h>maxa) {
            s.left=(w-maxa*h)+'px';
            w=maxa*h;
          } else s.left='0px';
        }
      } else {
        w=gmin*v.w,h=gmin*v.h
      }
      camera.aspect=w/h;//window.innerWidth/window.innerHeight;
      if (v.fovportrait) {
        var f=h/w,f0=v.fovptf0||1;
        camera.fov=(v.fov||60)+(f>f0?//>1
          //(f-1)*30
          (1/f0-1/f)*(v.fovptv||75)
          :0);
      }
      camera.updateProjectionMatrix();
      renderer.setSize(w,h);//window.innerWidth,window.innerHeight);
      v.wh=w;v.hh=h;
      //var s=renderer.domElement.style;
      s.position='absolute';
      if (!v.bg) {
        var x0=gmin*v.x,y0=gmin*v.y;v.xh=x0;v.yh=y0;
        s.left=x0+'px';s.top=y0+'px';
        s=v.textc.style;
        s.fontSize=(gmin*0.06)+'px';;
        var r=v.textc.getBoundingClientRect();
        //onsole.log(r);
        s.left=(x0+(w-r.width)/2)+'px';
        s.top=(y0+h-r.height)+'px';
      } else {
        s.left='0px';s.top='0px';
      }
    }
  }
  function setTargetCampos(tx,ty,tz,cx,cy,cz) {
    console.log('setTargetCampos');
    var v=views[0];
    aa.c0.copy(v.vr?base.position:v.camera.position);
    if (v.controls) aa.t0.copy(v.controls.target);
    if (v.vr) { 
      var rvr=v.renderer.vr;
      //onsole.log('setTargetcampos '+rvr.getDevice());
      cx=-cx;cy=(//rvr.userHeight//rvr.getDevice()
       //?rvr.userHeight:0
       vrUserHeight
       )-cy;cz=-cz; //1.6
    }
    aa.c1.x=cx;aa.c1.y=cy;aa.c1.z=cz;
    aa.t1.x=tx;aa.t1.y=ty;aa.t1.z=tz;
    
    //aa.c1.x=a.cx;aa.c1.y=a.cy;aa.c1.z=a.cz;
    //aa.t1.x=a.tx;aa.t1.y=a.ty;aa.t1.z=a.tz;
    taa=tam;
    //v.camera.position.set(a.cx,a.cy,a.cz);
    //v.controls.target.set(a.tx,a.ty,a.tz);
    
    //...
  }
  function viewAnchor(a) {
    //
    var v=views[0];
    if (canch) {
      if (canch.next) {
        for (var i=0;i<canch.next.length;i++) {
          base.remove(anchors[canch.next[i]].mesh);
        }
      }
    }
    if (a.campos!==undefined) {
      var ca=a.campos,ta=a.target;
      setTargetCampos(ta[0],ta[1],ta[2],ca[0],ca[1],ca[2]);
      /*
      aa.c0.copy(v.camera.position);
      aa.t0.copy(v.controls.target);
      var ah=a.campos;
      aa.c1.x=ah[0];aa.c1.y=ah[1];aa.c1.z=ah[2];
      ah=a.target;
      aa.t1.x=ah[0];aa.t1.y=ah[1];aa.t1.z=ah[2];
      
      //aa.c1.x=a.cx;aa.c1.y=a.cy;aa.c1.z=a.cz;
      //aa.t1.x=a.tx;aa.t1.y=a.ty;aa.t1.z=a.tz;
      taa=tam;
      //v.camera.position.set(a.cx,a.cy,a.cz);
      //v.controls.target.set(a.tx,a.ty,a.tz);
      */
    }
    if (a.next) {
      for (var i=0;i<a.next.length;i++) {
        base.add(anchors[a.next[i]].mesh);
      }
    }
    canch=a;
    //console.log(a);
    //base.remove(a.mesh);
    //...
  }
  function f4(v) {
    return Math.floor(0.5+v*10000)/10000;//...
  }
  function angleKeys(kA,kD,kW,kS) {
    //....
    var a=(kD&&kW?3*PI/4:(kD&&kS?PI/4:(kA&&kW?-3*PI/4:(kA&&kS?-PI/4:
        (kA?-PI/2:(kD?PI/2:(kS?0:PI)))))));//da=dAng(o.roty,a-baseRot.y);
    return a;
    //...
  }
  function len2(x0,y0,x1,y1) {
    var dx=x1-x0,dy=y1-y0;
    return dx*dx+dy*dy;
  }
  function dist2(o0,o1) {
    var dx=o0.x-o1.x;
    //var dy=o0.y-o1.y;
    var dz=o0.z-o1.z;
    return dx*dx//+dy*dy
      +dz*dz;
  }
  
  function ps(ps) {
    var dy=ps.dy||0.6;
    
    var o=pts2.pop();
    if (o) {
      for (var v of o.verts) {
        v.ox=ps.x;v.oy=ps.y+dy;v.os=ps.z;
      }
      o.t=0;
      pts.push(o);
      base.add(o.ps);
      return;
    }
    
    //...
    //onsole.log('planim.ps ');
    //onsole.log(ps);
    var geometry=new THREE.BufferGeometry();
    var vertices=[],verts=[];
    var sprite=new THREE.TextureLoader().load('/shooter/boom.png');
    for (var i=0;i<50;i++) {
      var vx=(Math.random()-0.5),vz=(Math.random()-0.5),vl=Math.sqrt(vx*vx+vz*vz)/(Math.random()*1.5);
      var v={ox:ps.x,oy:ps.y+dy,oz:ps.z,vx:vx/vl,vz:vz/vl};
      verts.push(v);
      //var x=2*Math.random()-1;
      //var y=2*Math.random()-1;
      //var z=2*Math.random()-1;
      vertices.push(v.ox,v.oy,v.oz);
    }
    var ba=new THREE.Float32BufferAttribute(vertices,3);
    geometry.addAttribute('position',ba);
    material=new THREE.PointsMaterial({size:3,sizeAttenuation:true,map:sprite,transparent:true,color:'#f00'});
    //material.color.setHSL( 1.0, 0.3, 0.7 );
    var ps=new THREE.Points(geometry,material);
    //particles.sortParticles=true;
    base.add(ps);
    pts.push({ps:ps,ba:ba,mat:material,verts:verts,t:0,mt:500,dy:dy});
    //...
  }
  function psCalc(dt) {
    //...
    for (var j=pts.length-1;j>=0;j--) {
      var o=pts[j];
      o.t+=dt;
      if (o.t>o.mt) {
        pts.splice(j,1);
        base.remove(o.ps);
        pts2.push(o);
        continue;
      }
      var f=o.t/o.mt,ba=o.ba,a=ba.array,verts=o.verts;
      for (var i=verts.length-1;i>=0;i--) {
        var v=verts[i];
        a[i*3]=v.ox+v.vx*f;
        a[i*3+1]=v.oy-Math.sin(PI/2*f)*o.dy;
        a[i*3+2]=v.oz+v.vz*f;
      }
      ba.needsUpdate=true;
      o.mat.size=Math.sin(PI*f)*2;
    }
    //...
  }
  
  function animDefMoves(dt) {
    var os=threeEnv.os,controlo=self.controlo;
    for (var i=os.length-1;i>=0;i--) {
      var o5=os[i],o=o5.ps;
      if (o.env) continue;
      if (o.health==0) {
         Pd5.animStart(o5,o5.animh[o.animDead]);
         continue;
      }
      
      if (self.defMoveAi)
      if (o!=controlo) {
        var ofoc=o.focus;
        if (ofoc) {
          o.turnLeft=false;
          o.turnRight=false;
          o.goFront=false;
          o.attack=false;
          if (ofoc.maxt) { o.focust+=dt;if (o.focust>ofoc.maxt) delete(o.focus); }
          ////o.focust+=dt;if (o.focust>5000) delete(o.focus);
          ////console.log('animDefMoves focus ');
          ////delete(o.focus);
          
          //var da=dAng(o.roty,angle(o.pos,ofoc.pos));
          //if (da<-0.1) o.turnLeft=true;
          //if (da>0.1) o.turnRight=true;
          
          var d2=dist2(o.pos,ofoc.pos);
          var wp=(ofoc.health===undefined);
          if (!wp&&((d2>30)||(ofoc.health<=0))) delete(o.focus); else {
          
            var da=dAng(o.roty,angle(o.pos,ofoc.pos));
            if (da<-0.1) o.turnLeft=true;
            if (da>0.1) o.turnRight=true;
          
            if (Math.abs(da)<0.2) {
              //var da;
              if (wp) da=0.05; else { da=o.collr+(ofoc.collr||0);da=da*da+1; }
              if (d2<=da) {
                if (wp) {
                  delete(o.focus); 
                  o.turnLeft=false;o.turnRight=false;
                } else o.attack=true; 
              } else o.goFront=true;
            }
          }
          //console.log(ofoc.health);
          //if (ofoc.health<=0) { delete(o.focus);o.attack=false; }
        } else {
          o.idlet=(o.idlet||0)+dt;
          if (o.idlet>300) {
            o.idlet=0;var done=false;
            if (o.attackParty) { //first since craft
              //onet.log('look for party nao.');
              for (var j=os.length-1;j>=0;j--) {
                var o5j=os[j],oj=o5j.ps;
                if ((oj.party===undefined)||(oj.party==o.party)||(oj.health<=0)) continue;
                if (dist2(o.pos,oj.pos)<(o.collr+oj.collr+5)) {
                  o.focus=oj;
                  o.focust=0;
                  done=true;
                  if (o.onfocus) o.onfocus();
                }
              }
            }
            if (controlo&&(controlo.health>0)&&(dist2(o.pos,controlo.pos)<(o.collr+controlo.collr+5))) {
              o.focus=controlo;
              o.focust=0;
              done=true;
            }
            if (!done&&(o.randomWalk!==false)) {
              var v=rani(4);
              o.turnLeft=(v==0);
              o.turnRight=(v==1);
              o.goFront=rani(3)==0;
            }
          }
        }
      }
      
      //if (o.turnLeft||o.turnRight) 
      //  o.roty+=((o.turnLeft?1:0)+(o.turnRight?-1:0))*dt*(o.vrot||0.003);
      if (o.hite) {
        Pd5.animStart(o5,o5.animh[o.animHit]);
        o.hitt+=dt;
        if (!o.hite.psDone) {
          ps({x:o.pos.x,y:o.pos.y,z:o.pos.z,dy:0.8});
          o.hite.psDone=true;
        }
        if (o.hitt>250) {
          //threePs({x:o.x*100,y:o.y*100+60,z:o.z*100});
          //ps({x:o.pos.x,y:o.pos.y,z:o.pos.z,dy:0.8});
          //ps({x:10,y:10,z:10});
          o.focus=o.hite.o;o.focust=0;
          o.health=Math.max(0,o.health-(o.focus.ap||1));
          if (o5.bb) o5.bb.update=true;
          delete(o.hite);
        }
      } else if (o.attack) {
        Pd5.animStart(o5,o5.animh[o.animAttack]);
      } else {
      
      if (o.turnLeft||o.turnRight) 
        o.roty+=((o.turnLeft?1:0)+(o.turnRight?-1:0))*dt*(o.vrot||0.003);
      
      if (o.goFront||o.goBack||o.goLeft||o.goRight) {
        var vx=0,vz=0,v=o.v||vdef;
        if (o.goLeft) vx=-0.5; if (o.goRight) vx+=0.5;
        if (o.goFront) vz=1; if (o.goBack) vz-=0.5;
        var vx0=vz*Math.sin(o.roty)-vx*Math.cos(o.roty),
            vz0=vz*Math.cos(o.roty)+vx*Math.sin(o.roty);
        var x=o.pos.x+vx0*dt*v,
            z=o.pos.z+vz0*dt*v;
        var b=self.moveBounds;
        if (b) {
          x=Math.min(b.x1,Math.max(b.x0,x));
          z=Math.min(b.z1,Math.max(b.z0,z));
        }
        if (o.collr) {
          var r0=o.collr;
          for (var h=os.length-1;h>=0;h--) {
            if (i==h) continue;
            var oh=os[h].ps,r1=oh.collr;
            if (!r1) continue;
            var d=len2(x,z,oh.pos.x,oh.pos.z),md=(r0+r1);//*0.4;
            if (d>=md*md) continue;
            d=Math.sqrt(d);
            x=oh.pos.x+(x-oh.pos.x)*md/d;
            z=oh.pos.z+(z-oh.pos.z)*md/d;
          }
        }
        o.pos.x=x;o.pos.z=z;
        Pd5.animStart(o5,o5.animh[o.animRun]);
      } else if (!o.isSpecial) {
        var an=o.animIdle||o.anim;//o5.animh[o.animIdle||o.anim];
        if (o5.anim!=an) Pd5.animStart(o5,an);
      }
    }}
    //...
  }
  function animate() {
    //requestAnimationFrame(animate);
    //controls.update(); // required if controls.enableDamping = true, or if controls.autoRotate = true
    stats.update();
    //if (threeEnv.os.length>0) threeEnv.os[0].meshes[0].tmesh.rotation.y+=0.01;
    
    var t=Date.now(),dto=Math.min(100,(t-ot)),dt=dto*dtscale,tsd0,tsd1;ot=t;
    //console.log('anim.animate dt='+dt);
    if (self.tsd) { tsd0=self.tsd[0];tsd1=self.tsd[1]; }
    
    var o=self.controlo,ip=self.isoCamPos,strafe=planim.strafe;//ip?ip.strafe:0;
    if (o) { //! startete in sizes.js
      o.attack=keys[96]||self.maction.on||keys[69];//num-0,e
      var kA=keys[65],kD=keys[68],kW=keys[87],kS=keys[83],
          kL=keys[37],kR=keys[39],kU=keys[38],kDn=keys[40],
          ts0;
      if (self.tsd) {
        ts0=self.tsd[0];
        if (ts0.dx<-0.3) kA=true;
        if (ts0.dx>0.3) kD=true;
        if (ts0.dy<-0.3) kW=true;
        if (ts0.dy>0.3) kS=true;
        var ts1=self.tsd[1];
        if (strafe) {
          if (ts1.dx<-0.3) kL=true;
          if (ts1.dx>0.3) kR=true;
          if (ts1.dy<-0.3) kU=true;
          if (ts1.dy>0.3) kDn=true;
        } else {
          if (ts1.dx==0) baseRot.yo=baseRot.y;
          else baseRot.y=baseRot.yo+ts1.dx;
        }
      }
      o.turnLeft=false;o.turnRight=false;
      o.goFront=false;o.goBack=false;o.goLeft=false;o.goRight=false;
      
      if ((kL||kR)&&!strafe) {
        //if (strafe) { o.turnLeft=kL;o.turnRight=kR; } else {
        var dry=((kL?-1:0)+(kR?1:0))*dto*0.003;
        baseRot.y+=dry;
        //}
      }
      if (ip&&strafe&&(kL||kR||kU||kDn)) {
        var a=angleKeys(kL,kR,kU,kDn),da=dAng(o.roty,a-baseRot.y);
        if (da<-PI/18) o.turnLeft=true;
        if (da>PI/18) o.turnRight=true;
        //tIsoStrafe=0;
      }
      //if (kU||kDn) { baseRot.x=Math.min(0.8,Math.max(-0.3,baseRot.x+((kU?-1:0)+(kDn?1:0))*dto*0.001)); }
      //if (kU||kDn) console.log(baseRot.x);
      if (ip) {
        
        //test: after a while switch into no strafe mode, but that
        //      doesnt work for long ranged strafe shootings.
        //tIsoStrafe+=dt;if (tIsoStrafe>500) strafe=0;
        
        if (kA||kD||kW||kS) {
          //var a=(kD&&kW?3*PI/4:(kD&&kS?PI/4:(kA&&kW?-3*PI/4:(kA&&kS?-PI/4:
          //    (kA?-PI/2:(kD?PI/2:(kS?0:PI))))))),
          var a=undefined;
          if (ts0) if ((Math.abs(ts0.dx)>0.3)||(Math.abs(ts0.dy)>0.3)) 
            a=Math.atan2(ts0.dx,ts0.dy);
          
          if (a===undefined) a=angleKeys(kA,kD,kW,kS);
          var da=dAng(o.roty,a-baseRot.y);
          var ada=Math.abs(da);
          
          if (strafe) {
            if (ada<3*PI/8) o.goFront=true;
            if (ada>5*PI/8) o.goBack=true;
            if ((da<-PI/8)&&(da>-7*PI/8)) o.goLeft=true;
            if ((da>PI/8)&&(da<7*PI/8)) o.goRight=true;
          } else {
            if (ada<=(dt*(o.vrot||0.003))) o.roty-=da; else 
            if (da>0.1) o.turnRight=true;
            else if (da<-0.1) o.turnLeft=true;
            if (ada<0.9) o.goFront=true;
          }
        }
      } else {
        if (strafe) {
          o.goLeft=kA;
          o.goRight=kD;
          o.turnLeft=kL;
          o.turnRight=kR;
        } else {
          o.turnLeft=kA;//37];
          o.turnRight=kD;//39];
        }
        o.goFront=kW;//38];
        o.goBack=kS;//40];
      }
    }
    
    if (game.calc) game.calc(dt);
    
    if (game.defMoves) animDefMoves(dt);
    
    if (Pd5.dynamicsWorld) Pd5.dynamicsWorld.stepSimulation1(dt/1000);
    
    psCalc(dt);
    //hreePsCalc();
    threeRender(dt);
    
    if (self.ego) {
      var o=self.ego,p=o.pos,m=base.matrix,camPos=self.camPos;//,ip=self.isoCamPos;
      vh0.set(0,0,0);
      m.identity();m.setPosition(vh0);
      if (!ip) {
    
        if (camPos) {
          //mh0.makeTranslation(-0.5,-1.5,-3);
          mh0.makeTranslation(camPos.x,camPos.y,camPos.z);
          m.multiply(mh0);
        }
    
        //mh0.makeRotationX(-0.2);m.multiply(mh0);
    
        mh0.makeRotationY(-o.roty+Math.PI);
        m.multiply(mh0);
      }
      if (ip) { 
    
        mh0.makeTranslation(ip.x,ip.y,ip.z);
        m.multiply(mh0);
        mh0.makeRotationX(baseRot.x);
        m.multiply(mh0);
        mh0.makeRotationY(baseRot.y);
        m.multiply(mh0);
        //vh0.set(-p.x+ip.x,-p.y+ip.y,-p.z+ip.z); 
        vh0.set(-p.x,-p.y,-p.z); 
      } else if ((!camPos)&&o.o&&o.o.eyew) {//o.o.eyew) {
        var p1=o.o.eyew.p1,f=o.o.scale,a=o.roty;//+o.rotofs-Math.PI;//f=350
        vh0.set(
          -p.x-(-p1.x*Math.cos(a)+p1.z*Math.sin(a))*o.scale*f
         ,-p.y-p1.y*o.scale*f+vrUserHeight
         ,-p.z+(-p1.x*Math.sin(a)-p1.z*Math.cos(a))*o.scale*f
         );
      } else {
        vh0.set(-p.x,-p.y-(camPos?0:1.75),-p.z);
        //vh0.set(-p.x,-p.y-1.75,-p.z);
      }  
      mh0.identity();mh0.setPosition(vh0);//new THREE.Vector3(-p.x,-p.y,-p.z));
      m.multiply(mh0);
    
      base.matrixAutoUpdate=false;
      base.matrixWorldNeedsUpdate=true;
    }
    
    var raremt=300;
    raret+=dt;
    if (raret>=raremt) { raret=0;var v0=views[0];if (v0) {
      rvr=v0.renderer.vr;vrd=rvr.getDevice();
      //console.log('rvr.userHeight='+rvr.userHeight);
      //if (vrd!=vrdevice) 
      {
        vrdevice=vrd;
        //if (vrd) 
        var nuh=rvr.userHeight||0;
        if ((vrUserHeight!=nuh)&&(rvr.enabled))
        {
          base.position.y+=nuh-vrUserHeight;
          vrUserHeight=nuh;self.vrUserHeight=nuh;
          //base.position.set(0,nuh,0);
          //vrUserHeight=rvr.userHeight||0;
          //out('vruh='+vrUserHeight);
        }
      }
      if (recording) {
        var bp=base.position,cp=v0.camera.position,cq=v0.camera.quaternion;
        record.push([f4(bp.x),f4(bp.y),f4(bp.z),f4(cp.x),f4(cp.y),f4(cp.z),f4(cq.x),f4(cq.y),f4(cq.z),f4(cq.w)]);
        debug='Recording '+record.length+', [r] stop';
        updateHud();
      }
      if (game.rays) click=new THREE.Vector2(0,0);
    }}
    
    if (viewing) {
      viewt+=dt;var mt=raremt;
      while (viewt>mt) {
        viewt-=mt;viewi++; 
        if (viewi==record.length-1) viewi=0;
      }
      var a0=record[viewi],a1=record[viewi+1],cam=views[0].camera,f1=viewt/mt,f0=1-f1;
      base.position.set(a0[0]*f0+a1[0]*f1,a0[1]*f0+a1[1]*f1,a0[2]*f0+a1[2]*f1);
      cam.position.set(a0[3]*f0+a1[3]*f1,a0[4]*f0+a1[4]*f1,a0[5]*f0+a1[5]*f1);
      vq0.set(a0[6],a0[7],a0[8],a0[9]);
      vq1.set(a1[6],a1[7],a1[8],a1[9]);
      vq0.slerp(vq1,f1);
      cam.quaternion.copy(vq0);//set(a0[6],a0[7],a0[8],a0[9]);
      out('Viewing '+(viewi+1)+'/'+(record.length-1)+' [v] stop');
    }
    
    if (taa>0) {
      taa=Math.max(0,taa-dt);
      var f0=taa/tam,f1=1-f0,v=views[0];
      var o3d=v.vr?base:v.camera;
      //if (!v.vr) {
        //v.camera.
        o3d.position.set(aa.c0.x*f0+aa.c1.x*f1,aa.c0.y*f0+aa.c1.y*f1,aa.c0.z*f0+aa.c1.z*f1);
        if (v.controls) v.controls.target.set(aa.t0.x*f0+aa.t1.x*f1,aa.t0.y*f0+aa.t1.y*f1,aa.t0.z*f0+aa.t1.z*f1); 
      //}
    }
    
    if (self.vrkeys&&(views.length>0)&&!cmenu) {//&&!self.ego) {
      var cam=views[0].camera,rf=0.003;
      if (keys[38]) cam.rotation.x+=rf*dto;
      if (keys[40]) cam.rotation.x-=rf*dto;
      if (keys[37]) cam.rotation.y+=rf*dto;
      if (keys[39]) cam.rotation.y-=rf*dto;
      var tsd1=self.tsd?self.tsd[1]:undefined;
      if (tsd1&&!fetch) {
        cam.rotation.x-=tsd1.dy*dto*rf;
        cam.rotation.y-=tsd1.dx*dto*rf;
      }
      //onsole.log('vrkeys '+mD+' '+JSON.stringify(inp));
      if (mD&&(inp.lastButton==2)) {
        //onsole.log('vrkeys mD');
        var mousesense=3;
        cam.rotation.x+=(inp.camx-(inp.y-inp.y0)*mousesense-cam.rotation.x)/4;
        cam.rotation.y+=(inp.camy-(inp.x-inp.x0)*mousesense-cam.rotation.y)/4;
        //cam.rotation.y-=tsd1.dx*dto*rf;
      }
      //console.log(camera.quaternion);
      if (!self.ego) {
      var kleft=keys[65],kright=keys[68],kfore=keys[87],kback=keys[83],kup=keys[81],kdown=keys[69],
          tsd0change=tsd0?(Math.abs(tsd0.dx)>0.1||Math.abs(tsd0.dy)>0.1||(fetch&&Math.abs(tsd1.dy)>0.1)):false;
      if (kleft||kright||kfore||kback||kup||kdown||tsd0change) {
        camv+=0.000001*dto;camkt+=dto;
        //out('camv '+f4(camv));
        var v=new THREE.Vector3();//,f=0.003;
        if (kleft) v.x+=1;if (kright) v.x-=1;
        if (kfore) v.z+=1;if (kback) v.z-=1;
        if (tsd0change) { 
          v.x=-tsd0.dx;
          if (fetch) v.y=tsd1.dy;
          //if (self.mtsd0y.checked) v.y=tsd0.dy; else 
          v.z=-tsd0.dy; 
        }
        if (kup) v.y-=1;if (kdown) v.y+=1;
        if (game.curskeys&&game.curskeys(v,dt)) {
          //---
        }  else 
        if (self.cursscale) {
          v.z=v.x;v.y=v.x;
          v.multiplyScalar(0.001*dto/base.scale.x);
          //if (vrd) 
          base.position.y-=vrUserHeight;//rvr.userHeight||0;
          base.position.multiplyScalar(1/base.scale.x);
          base.scale.add(v);
          base.position.multiplyScalar(base.scale.x);
          //if (vrd) 
          base.position.y+=vrUserHeight;//rvr.userHeight||0;
          base.updateMatrix();
          out('Base.scale '+f4(base.scale.x));
        } else {
          v.multiplyScalar(camv//
            //((camkt>3000)?0.01:0.001)
            *dto);
          v.applyQuaternion(cam.quaternion);
          base.position.add(v);
          //onsole.log(base.position);
          base.updateMatrix();
        }
      } else { camv=self.startCamV;camkt=0; }
      }
    }
    
    if (fetch) {
      vh0.copy(fetch.position);
      var p=vh0;//fetch.position;
      p.copy(fetchop);
      p.add(fetchbp);
      p.sub(base.position);
      var fg=self.fetchGrid;
      if (fg!==undefined) {
        //fg*=2;
        p.x=Math.floor(p.x*fg+0.5)/fg;
        p.y=Math.floor(p.y*fg+0.5)/fg;
        p.z=Math.floor(p.z*fg+0.5)/fg;
      }
      p=fetch.position;
      if ((vh0.x!=p.x)||(vh0.y!=p.y)||(vh0.z!=p.z)) {
        p.copy(vh0);
      var o=fetch.userData.o;
      if (o) {
        o.ps.pos.copy(p);
        for (var m of o.meshes) {
          m=m.tmesh;
          m.position.copy(p);
          m.updateMatrix();
        }
      }
      out('fetchPos '+p.x+' '+p.y+' '+p.z,{sameline:1});
      if (planim.fetchMoved) planim.fetchMoved(fetch);
      fetch.updateMatrix();
      }
    }
    
    
    if (click) {
      //onsole.log('anim.animate click');
      raycaster.setFromCamera(click,views[0].camera);
      var intersects=raycaster.intersectObjects(base.children);
      //onsole.log('animate intersects.len='+intersects.length);
      click=undefined;
      if (intersects.length>0) {
        //onet.log('render intersects='+intersects.length);
        //var os=[];
        //for (var j=0;j<intersects.length;j++) {
        //  var o=intersects[j].object;//,found=false;
        //  //for (var i=os.length-1;i>=0;i--) if (os[i]=
        //  if (os.indexOf(o)) os.push(o);
        //}
        ////onet.log('os.len='+os.length);
        for (var j=0;j<(
         ////mmultisel.checked?
         intersects.length//:
         //1
         );j++) {
         var ij=intersects[j],o=ij.object;
         if (j==0) {
           if (o!=ray0) {
             if (ray0) if (ray0.select) ray0.select(false);
             ray0=o;
             if (o.select) o.select(true);
             //onsole.log('anim.animate ray0='+o.userData);
           }
         }
         //console.log('anim.animate ray at '+o+' '+j);
         //for (var j=0;j<os.length;j++) {
         //var o=os[j]; 
         var marko=o.userData.marko;
         //console.log(o.userData.o);
         if (marko) {
           //var v=views[0];
           //v.camera.position.set(-0.1542,-1.5406,0.8371);
           //v.controls.target.set(-0.1654,-1.5466,0.6055);
           //v.camera.position.set(0.2670,-0.4389,1.8301);
           //v.controls.target.set(0,-1.2,0);
           //console.log(v.controls);
           viewAnchor(marko);
           break;
         }
         if (o.userData.onclick) { o.userData.onclick(eclick,ij);break; }//,o);
         o=o.userData.o;
         //onsole.log(o);
         if (!o) continue;
         if (o.ps.onclick) { o.ps.onclick(eclick,ij);break; }
    //     for (var i=bricks.length-1;i>=0;i--) {
    //      var b=bricks[i];
    //      if (b.mesh!=o) continue;
    //      select(b,mmultisel.checked);
    //      //brickPos(sel,0);
    //      //sel=b;Menu.ms(mtype,sel.t);
    //      break;
    //     }
        }
      } else if (ray0) {
        if (ray0.select) ray0.select(false);
        ray0=undefined;
      }
    }
    
    if (game.calcLater) game.calcLater(dt);
    
    for (var i=views.length-1;i>=0;i--) {
      var view=views[i];
      if (view.controls) view.controls.update();
      view.renderer.render(scene,view.camera);
    }
  }
  function loadInit(o,ps) {
    //var ps=o.ps;
    o.ps=ps;ps.o=o;
    
    o.scale=1;//dont use scale from editor
    if (ps.roty===undefined) ps.roty=0;
    //if (ps.bb) { if (!ps.health) ps.health=5;if (!ps.bby) ps.bby=1; }
    if ((ps.health!==undefined)&&!ps.mhealth) ps.mhealth=Math.max(1,ps.health);
    if (ps.posa&&!ps.pos) ps.pos=new THREE.Vector3(ps.posa[0],ps.posa[1],ps.posa[2]);
    if (!ps.env) ps.backup={x:ps.pos.x,y:ps.pos.y,z:ps.pos.z,roty:ps.roty,health:ps.health};
    //...
    
    if (ps.onload) ps.onload(o);
    
    //if (ps.ego) { self.controlo=planim.ego=o.ps; }
    
    //console.log(o);//Object.assign({},o));
    
    //Pd5.animStart(o,o.animh[ps.animIdle||ps.anim]);
    Pd5.animStart(o,ps.animIdle||ps.anim);
    //o.scale*=0.7;//o.x=-0.1;o.y=-0.7;o.z=-0.5;
    //o.scale*=1;o.x=-0.1;o.y=-0.5;o.z=-0.3;
    Pd5.calc(o,0,0.0,0,1,{x:0,y:0,z:0},0,0,true);
    
    //ps.o=o;o.ps=ps;//o.o={pos:ps.pos,roty:ps.roty||0};
    
    threeAddObj(o,0,0,0,ps.scale);
    var m=o.meshes[0].tmesh;
    m.userData.o=o;
    
    if (ps.select) for (var i=0;i<o.meshes.length;i++) {
      var mi=o.meshes[i].tmesh;
      mi.userData.o=o;
      mi.select=ps.select;
    }
    
    
    //o.o={pos:ps.pos,roty:ps.roty||0};
    //var m=o.meshes[0].tmesh;
    //m.position.copy(ps.pos);//set(-30,-140,-80);
    if (ps.ohkey) oh[ps.ohkey]=o;
    //if (ps.roty!==undefined) m.rotation.y=ps.roty;
    if (ps.ego) { self.controlo=planim.ego=o.ps;egoi=threeEnv.os.length-1; }
    
    //onsole.log('anim.loadInit');
    if (ps.bb) {
      //onsole.log('anim.loadInit bb');
      var oyw=1;
      o.bb=threeBillboardAdd({x:0,y:0,z:0,ar:ps.bbar||(0.1/oyw),s:0.01*(1+(oyw-1)*2),transparent:ps.bbtransp,gw:ps.bbgw});//,cw:o.bbcw});
      o.bb.o=o.ps;
      
      //console.log(o);
      //o.ps.health=3;o.ps.mhealth=5;
      //o.bb.update=1;
    }
    
    
    
    //console.log(o);
    var ac=0,startAnchor=undefined;
    if (!ps.noAnchors)
    for (var i=0;i<o.verts.length;i++) {
      var v=o.verts[i],w=0.15;
      if (!v.marko) continue;
      if (v.marko.t!='anchor') continue;
      
      var mesh=new THREE.Mesh(new THREE.BoxGeometry(w,w,w),m1);var b=mesh;
      mesh.position.set(v.p0.x*ps.scale+ps.pos.x,v.p0.y*ps.scale+ps.pos.y,v.p0.z*ps.scale+ps.pos.z);
      mesh.updateMatrix();
      mesh.matrixAutoUpdate=false;
      
      //var b=box(v.p0.x*ps.scale+ps.pos.x,v.p0.y*ps.scale+ps.pos.y,v.p0.z*ps.scale+ps.pos.z,w,w,w,m1);
      //b.castShadow=false;
      v.marko.mesh=b;
      b.userData.marko=v.marko;
      anchors[v.marko.k]=v.marko;
      if (v.marko.start) startAnchor=v.marko;
      ac++;
      //console.log(v);
    }
    
    if (startAnchor) viewAnchor(startAnchor);
    //v.camera.position.set(0.2670,-0.4389,1.8301);
    //v.controls.target.set(0,-1.2,0);
    //threeRender();
    //...
    //onsole.log('loadInit 0');
    loopAfterLoaded--;
    if (loopAfterLoaded==0) {
      //onsole.log('loadInit 1');
      if (scra.length>0) calcScra();
      if (game.allLoaded) game.allLoaded();
    }
    //var rvr=views[0].renderer.vr;
    //if (rvr.getDevice()) base.position.set(0,rvr.userHeight,0);
    
    //...
  }
  function oonload(v) {
    var ps=this;//console.log(this);
    var o=Pd5.load(v);
    //o.scale=1;//dont use scale from editor
    //onsole.log('anim.oonload');// o.scale=+o.scale);
    //onsole.log(ps);
    //ps.o=o;o.ps=ps;
    
    loadInit(o,ps);
  }
  function cload(o,ch) {
    var ps=ch;
    //o.ps=ps;ps.o=o;
    loadInit(o,ps);
    //console.log('anim.cload o ch');
    //console.log(o);
    //console.log(ch);
  }
  function calcScra() {
    var t=Date.now(),dt=t-ot;ot=t;
    //onsole.log(dt);
    scrt=Math.min(2500,scrt+dt);
    while (true) {
      var scr=scra[scri];
      if (scrt<scr.t) break;
      scr.f();
      scrt-=scr.t;
      scri=(scri+1)%scra.length;
    }
    
    //console.log('anim.calc '+(oh.templar?'1':'0'));
    //var ot=oh.templar,ob=oh.bot;
    //if (ot&&ob) {
    //  var a0=ot.animh.disagree;
    //  if (ot.anim===a0) {
    //    Pd5.animStart(ot,ot.animh.speak);
    //    Pd5.animStart(ob,ob.animh.disagree);
    //  } else {
    //    Pd5.animStart(ot,a0);
    //    Pd5.animStart(ob,ob.animh.speak);
    //  }
    //  //Pd5.animStart(o,o.anim===a0?o.animh.speak:a0);
    //}
    setTimeout(calcScra,20);
  }
  function viewText(i,sh) {
    var v=views[i],c=v.textc,s=c.style;
    if (sh.length==0) { s.display='none';return; }
    c.innerHTML=sh;s.display='';
    var r=c.getBoundingClientRect();//,s=v.textc.style;
    s.left=(v.xh+(v.wh-r.width)/2)+'px';
    s.top=(v.yh+v.hh-r.height)+'px';
    //...
  }
  function anim(os,as) {
    var o=oh[os];Pd5.animStart(o,o.animh[as]);
    //...
  }
  function loadObj(o) {
    //o==ps
    if (o.ego) self.ego=o;
    if (o.a) {
      o.cloadf=cload;
      Pd5.loadCombine(o);
    } else {
      if (!o.f) o.f=oonload;
      Conet.download(o);
    }
    //...
  }
  function loadObjsThenLoop(a) {
    loopAfterLoaded=a.length;
    for (var i=0;i<a.length;i++) {
      var ps=a[i];
      ps.loadIndex=i;
      loadObj(ps);
    }
    //...
  }
  function out(s,ps) {
    //console.log(s);
    if (views[0].hud) {
      debug=s;updateHud();//...
    } else Conet.log(s,ps);
  }
  function outMenu() {
    if (!cmenu) { out('[m] menu');return; }
    var s='';
    for (var i=0;i<cmenu.length;i++) {
      var sh=cmenu[i].s;
      if (i==menui) sh='<'+sh+'>';
      s+=(i>0?' ':'')+sh;
    }
    out('[asd] '+s);
    //...
  }
  function egoSwitch() {
    //...
    //if (o0.ego) { o0.ego=0;o1.ego=1; } 
    //else { o0.ego=1;o1.ego=0; }
    var os=threeEnv.os;
    if (planim.ego) planim.ego.ego=undefined;
    var i=egoi;
    while (1) {
      i++;
      if (i==os.length) { i=-1;break; }
      if (i==egoi) break;
      var oh=os[i].ps;
      if (!oh.env&&!oh.noEgo) break;
    }
    egoi=i;
    //egoi++;if (egoi==threeEnv.os.length) egoi=-1;
    console.log('anim.egoSwitch egoi='+egoi);
    self.controlo=planim.ego=egoi==-1?undefined:threeEnv.os[egoi].ps;
    var cam=views[0].camera;
    //cam.rotation.x=0;cam.rotation.y=0;
    //console.log(threeEnv.os);
    if (planim.ego) { //base.position.set(0,0,0);
      planim.ego.ego=1;if (self.vrkeysAuto||self.vrkeys) { self.vrkeys=0;cam.rotation.set(0,0,0); }}
    else if (!self.vrkeys) { self.vrkeys=1;self.vrkeysAuto=1; }
    //if (!planim.game.defMoves) {
    //  planim.vrkeys=!planim.ego;
    //  if (!planim.vrkeys) views[0].camera.rotation.set(0,0,0);
    //}
    console.log(planim.ego);
    //...
  }
  function keyDown(e) {
    //console.log('');
    if (vrbu) { vrbu.parentNode.removeChild(vrbu);vrbu=undefined; }
    
    
    var kc=e.keyCode;
    keys[kc]=true;
    //onsole.log('anim.keyDown kc='+kc);
    //if (views[0].vr) { debug=' kc='+kc;updateHud(); }
    
    if ((kc>=48)&&(kc<=57)) {
    var c=kc-48;
    var vh;
    switch (c) {
    case 0:vh=0;break;
    case 1:vh=0.01;break;
    case 2:vh=0.1;break;
    case 3:vh=0.2;break;
    case 4:vh=0.5;break;
    case 5:vh=1;break;
    case 6:vh=2;break;
    case 7:vh=5;break;
    case 8:vh=10;break;
    case 9:vh=20;break;
    }
    dtscale=vh;//gamespeed=vh;
    }
    
    //if (kc==32) { var v=views[0];console.log('keyDown campos,conroltarget');
    //console.log(v.camera.position);if (v.controls) console.log(v.controls.target); }
    
    if ((kc==77)&&self.menu) {
      if (cmenu) cmenu=undefined; else { 
        cmenu=self.menu;menui=0; }
      outMenu();
    }
    if (cmenu) {
      if (kc==65) { menui=(menui-1+cmenu.length)%cmenu.length;outMenu(); }
      if (kc==68) { menui=(menui+1)%cmenu.length;outMenu(); }
    }
    
    
    if (kc==82) { //r
      if (views[0].recordOnKey) {
        if (!record) { 
          record=[];
          recording=true; 
        } else {
          Conet.upload({fn:'/three/anim/cambaseRecord.json',data:JSON.stringify(record)});
          debug='Record saved to cambaseRecord.json.';
          updateHud();
          record=undefined;
          recording=false;
        }
      }
    }
    if (kc==86) { //v
      if (uiMode!=-1) uiToggle();
      else if (views[0].recordOnKey) {
        if (!record) {
          out('Loading record.');
          Conet.download({fn:'/three/anim/cambaseRecord.json',
    f:function(v) {
      record=JSON.parse(v);
      viewing=true;viewi=0;viewt=0;
    }
          });
        } else {
          viewing=false;
          record=undefined;
          out(' ');
        }
      }
    }
    //if ((kc==70)&&game.fetchOnKey) self.mfetch.action();//f
    //if (game.defMoves) {
    //onsole.log('anim.keydown0 '+kc);
    
    //--- following moved to mcamswitch
    //if (!game.noEgoSwitch) {
    //  if (kc==67) egoSwitch(); //c
    //}
    
    if (game.keyDown) game.keyDown(e);
    //...
  }
  function keyUp(e) {
    var kc=e.keyCode;
    keys[kc]=false;
    if (cmenu) {
      if ((kc==87)||(kc==83)) {
        var m=cmenu[menui];
        if (m.sub) {
          cmenu=m.sub;menui=0;
        } else 
          cmenu=undefined;
        outMenu();
        if (m.action) m.action();
        if (m.actionf) m.actionf();
      }
    }
    if (game.keyUp) game.keyUp(e);
  }
  function rani(n) {
    return Math.floor(Math.random()*n);
  }
  function onClick(e) {
    
    if (e&&(e.target!=views[0].renderer.domElement)) return;
    
    //onsole.log('planim.onClick 0');
    if (skipClick) { skipClick=false;return; }
    //onsole.log('planim.onClick 1');
    //onsole.log('anim.onClick');
    if (click) return;//dont overwrite first click
    eclick=e;
    //onsole.log(e);
    //if (e.detail<2) return;
    click=new THREE.Vector2(2*e.clientX/window.innerWidth-1,-2*e.clientY/window.innerHeight+1);
    //onsole.log(click);
  }
  function angle(o,pos) {
    var dx=pos.x-o.x;
    var dz=pos.z-o.z;
    //var l=Math.sqrt(dx*dx+dz*dz);
    var a=Math.atan2(dx,dz);
    return a;//...
  }
  function dAng(a0,a1) {
    var da=a0-a1;
    while (da>PI) da-=PI*2;
    while (da<-PI) da+=PI*2;
    return da;
  }
  function pointLight(ps) {
    //--
    var dist=ps.dist,l=new THREE.PointLight(ps.col,ps.int,dist);l.position.set(ps.x,ps.y,ps.z);
    if (ps.castShadow!==false) {
    l.castShadow=true;
    l.shadow.camera.near=0.1;//100;
    l.shadow.camera.far=dist;//1000;
    l.shadow.mapSize.width=1024;//2048;
    l.shadow.mapSize.height=1024;
    }
    base.add(l);
    return l;
    //...
  }
  function defaultLights() {
    var l0,l1,l2;
    base.add(l0=new THREE.AmbientLight(0xffffff,0.3));
    l1=pointLight({x:-1,y:2,z:1,col:0xffffaa,dist:10,int:2});
    //pointLight({x:-5.5,y:0,z:-1,col:0x2222ff,dist:7,int:2});
    l2=pointLight({x:5,y:-5,z:-5,col:0xaaffff,dist:100,int:0.5,castShadow:false});
    //var l=new THREE.DirectionalLight(0xaaffff,1);l.position.set(0.2,-1,-0.2);base.add(l);
    //...
    return [l0,l1,l2];
  }
  function init() {
    
    scene=new THREE.Scene();self.scene=scene;
    
    base=new THREE.Group();scene.add(base);self.base=base;
    
    //box(40,-80,0,-50,-100,-50,m1);
    //box(40+60,-80,30,-50,-50,-50,m1);
    //box(40,-80,60,-50,-100,-50,m1);
    //box(0,-150,0,600,20,600,m0).castShadow=false;
    
    //var l=new THREE.AmbientLight(0x999999),f=0.03;base.add(l);//0x555555
    //l=new THREE.PointLight(0xffffaa,1,0);l.position.set(-100*f,200*f,100*f);base.add(l);
    ////pointLight({x:3,y:3,z:3,col:0xffffff,dist:10,int:2});
    //var l=new THREE.PointLight(0xffffff,1,0);l.position.set(100*f,100*f,100*f);
    //l.castShadow=true;
    //l.shadow.camera.near=0.1;//100;
    //l.shadow.camera.far=10;//1000;
    //l.shadow.mapSize.width=1024;//2048;
    //l.shadow.mapSize.height=1024;
    //base.add(l);
    //l=new THREE.PointLight(0xaaffff,1,0);l.position.set(3,-6,-3);base.add(l);
    
    stats=new Stats();var c=stats.domElement,s=c.style;
    s.position='absolute';s.top='0px';s.zIndex=100;s.opacity=0.3;
    container.appendChild(c);
    
    window.addEventListener('resize',resize,false);
    window.addEventListener('keydown',keyDown);
    window.addEventListener('keyup',keyUp);
    window.addEventListener('click',onClick,false);
    
    var tapstart=0,c=window,touchEnded=true;
    function coords(e) {
      var iw=window.innerWidth,ih=window.innerHeight;
      inp.x=2*e.clientX/iw-1;inp.y=2*e.clientY/ih-1;
      inp.x*=iw/ih;
      //...
    }
    
    function mouseScroll(e) {
      //...
      var up=false;
      if (e.wheelDelta!=undefined) up=e.wheelDelta>0;
      else up=e.detail<0;
      
      //onsole.log('anim.mouseScroll up='+up);
      //onsole.log(self.mouseScroll);
      if (self.mouseScroll) self.mouseScroll(up);
      //...
    }
    
    c.addEventListener('DOMMouseScroll',mouseScroll,false);
    c.addEventListener('mousewheel',mouseScroll,false);
    c.addEventListener('mousedown',function(e) {
      //onsole.log('anim.mousedown0');//console.log(e.target);
      if (e.target!=views[0].renderer.domElement) return;
      //onsole.log('anim.mousedown1');//console.log(e.target);
      tapstart=Date.now();mD=true;
      
      //var iw=window.innerWidth,ih=window.innerHeight,x=2*e.clientX/iw-1,y=2*e.clientY/ih-1;
      //x*=iw/ih;
      coords(e);inp.x0=inp.x;inp.y0=inp.y;
      var cam=views[0].camera;inp.camx=cam.rotation.x;inp.camy=cam.rotation.y;
      inp.button=e.button;inp.lastButton=e.button;
      //onsole.log(inp);
      if (self.inpDown) self.inpDown(inp);
      //onsole.log('anim.mousedown self.dragRays='+self.dragRays);
      if (self.dragRays) onClick(e);
      inp.button=undefined;
    }
    ,false);
    c.addEventListener('mouseup',function(e) {
      //onsole.log('anim.mouseup');
      
      //--- following to avoid click event after viewchange (long mousdown/touch)
      //--- update: commented it out, it was needed for orbitcontrols which isnt
      //    used much anymore (instead: vrkeys/touchstick/rightdrag)
      //--- 190512 removed comments, conditioned on oribitalcontrols
      
      if (controls) if (Date.now()-tapstart>300) skipClick=true;
      
      mD=false;
    }
    ,false);
    //if (0)
    c.addEventListener('mousemove',function(e) {
      if (!mD) return;
      if (vrbu) { vrbu.parentNode.removeChild(vrbu);vrbu=undefined; }
      //var iw=window.innerWidth,ih=window.innerHeight,x=2*e.clientX/iw-1,y=2*e.clientY/ih-1;
      //x*=iw/ih;
      //onsole.log('anim.mouseMove '+x+' '+y);
      coords(e);
      if (self.inpMove) self.inpMove(inp);
      if (self.dragRays) onClick(e);
    }
    ,false);
    
    c.addEventListener('touchstart',function(e) {
      //onsole.log('anim.touchStart0');
      
      //---190512 else deep8 with doubleclicks
      if (e.preventDefault) e.preventDefault();
      if (e.stopPropagation) e.stopPropagation();
      
      var et=e.touches,l=et.length;
      if (e.target!=views[0].renderer.domElement) return;
      if (//self.dragRays&&
        l==1) { et[0].type='touchstart';onClick(et[0]); }
      if (!self.inpDown) return;
      //onsole.log('anim.touchStart1');
      //if (e.target!=views[0].renderer.domElement) return;
      touchEnded=false;
      //var et=e.touches,l=et.length;
      if (l==1) {
        coords(et[0]);
        self.inpDown(inp);
      } else if (l==2) {
        var x0=et[0].clientX,y0=et[0].clientY,
            x1=et[1].clientX,y1=et[1].clientY,
            dx=x1-x0,dy=y1-y0;
        coords({clientX:(x0+x1)/2,clientY:(y0+y1)/2});
        inp.dist=Math.sqrt(dx*dx+dy*dy);
        inp.ang=Math.atan2(dy,dx);
        self.inpDown(inp);
        inp.ang=undefined;
        inp.dist=undefined;
      }
    }
    ,{passive:false});
    c.addEventListener('touchmove',function(e) {
      //onsole.log('touchmove0 '+touchEnded);
      if (e.preventDefault) e.preventDefault();
      if (e.stopPropagation) e.stopPropagation();
      var et=e.touches,l=et.length;
      //onsole.log('touchmove1');
      if (self.dragRays&&l==1) { et[0].type='touchmove';onClick(et[0]); }
      if (touchEnded) return;
      if (!self.inpMove) return;
      if (l==1) {
        coords(et[0]);
        self.inpMove(inp);
        //if (self.dragRays) onClick(et[0]);
      } else if (l==2) {
        var x0=et[0].clientX,y0=et[0].clientY,
            x1=et[1].clientX,y1=et[1].clientY,
            dx=x1-x0,dy=y1-y0;
        coords({clientX:(x0+x1)/2,clientY:(y0+y1)/2});
        inp.dist=Math.sqrt(dx*dx+dy*dy);
        inp.ang=Math.atan2(dy,dx);
        self.inpMove(inp);
        inp.ang=undefined;
        inp.dist=undefined;
      }
      //...
    }
    ,{passive:false});
    c.addEventListener('touchend',function(e) {
      touchEnded=true;
      //onsole.log('anim.touchend');
    }
    ,{passive:false});
    
    //| ---
    
    
    // animate();
    
    //threeEnv.renderer=renderer;
    if (0)
    Pd5.animText=function(o,s) {
      //...
    }
    threeEnv.base=base;//scene;
    threeEnv.scene=scene;
    //threeEnv.camera=views[0].camera;
    threeEnv.path='../shooter/';
    threeEnv.aipos=1;
    //threeEnv.dtscale=0.5;
    
    //var sc=document.createElement('script');
    //sc.src='anim/dialogJavaJavascript.js';
    //document.body.appendChild(sc);
    url=Conet.parseUrl();self.url=url;
    
    var ka=[];
    for (var k in url) if (url.hasOwnProperty(k)) if (k.startsWith('sn')) ka.push(k);
    //onsole.log(ka);
    
    if (ka.length>0) {
      
      var scCount=ka.length;
      
    function sconload() {
      //onsole.log('anim.init script loaded '+this.src+' '+self.scriptsLoaded.length);
      //console.log(this.body);
      //indow.scpl=this;
      scCount--;
      if (scCount>0) return;
      
      //onsole.log('anim.init: Running '+self.scriptsLoaded.length+' functions in scriptsLoaded.');
      for (var f of self.scriptsLoaded) f();
      
      resize();
    }
       
      for (var k of ka) {
        var sc=document.createElement('script'),fn=url[k];
        sc.onload=sconload;
        sc.src=fn;
        document.body.appendChild(sc);
        //onsole.log('anim.init loading script '+fn);
      }
      
      if (0) {
      var sc=document.createElement('script');
    sc.onload=function() {
      //console.log('Script loaded: '+url.sn);
      resize();
      //var rvr=views[0].renderer.vr;
      //if (rvr.getDevice()) base.position.set(0,-rvr.userHeight,0);
      
    }
      sc.src=url.sn;
      document.body.appendChild(sc);
      }
    } else {
    
    var fn=url.fn
      //||'anim/dialogJavaJavascript.js';
      //||'anim/base.js';
      //||'anim/tiles.js';
      ||'anim/static.js';
    //var fn='anim/base.js';
    
    Conet.download({fn:fn,f:function(v) {
      eval(v);//...
      //(new Function(v))();
    }
    });
    //calc();
    }
    
    var sh='Anim '+version;
    console.log(sh);
    //onet.log(sh);
    Sound.soundDir='/shooter/sound/';
    //...
  }
  function initVr() {
    if (self.initVrStart) self.initVrStart();
    delete(self.tsd);
    Menu.touchSticksRemove();
    
    var renderer=views[0].renderer;
    renderer.vr.enabled=true;
    
    window.addEventListener('vrdisplaypointerrestricted',function() {
      var pointerLockElement=renderer.domElement;
      if (pointerLockElement&&typeof(pointerLockElement.requestPointerLock)==='function' ) {
        pointerLockElement.requestPointerLock();
      }
    }
    ,false);
    window.addEventListener('vrdisplaypointerunrestricted',function() {
      var currentPointerLockElement=document.pointerLockElement;
      var expectedPointerLockElement=renderer.domElement;
      if (currentPointerLockElement&&currentPointerLockElement===expectedPointerLockElement&&typeof(document.exitPointerLock)==='function' ) {
        document.exitPointerLock();
      }
    }
    ,false);
     
      var b=WEBVR.createButton(renderer,{frameOfReferenceType:'head-model'});
      ////console.log('button.ih='+b.innerHTML);
      ////console.log(renderer.vr);
      document.body.appendChild(b);
    //...
    //if (withClick&&b.onclick) b.onclick(); ---autoclick doesnt work :/
  }
  //--- ui = cam & control
  function uiToggle() {
    uiSet((uiMode+1)%5);
    //...
  }
  function nu(v0,v1) {
    if (v0!==undefined) return v0;
    return v1;
  }
  function uiSet(i,ps) {
    if (!ps) ps={};
    var planim=self,o=self.ego;
    delete(planim.camPos);
    delete(planim.isoCamPos);
    planim.strafe=0;
    planim.baseRot.x=0;
    
    
    switch (i) {
      case 0:
        //leftstick moves,rotates unit and rotates cam
        o.vrot=0.003;planim.strafe=1;
        break;
      case 1:
        o.vrot=0.003;
        planim.camPos={x:0.5,y:-1.5,z:-1};planim.strafe=1;//shoulder
        break;
      case 2:
        o.vrot=0.003;
        planim.camPos={x:0.5,y:-1.5,z:-3};planim.strafe=1;//3rd person
        break;
      case 3:
        //leftstick moves,rotates unit,rightstick not needed or rotates cam
        //if (o) o.vrot=0.01;
        planim.isoCamPos={x:0
          ,y:nu(ps.camy,-1.5)//-1.5
          ,z:nu(ps.camz,-3)};
          planim.baseRot.x=0.3;
        //planim.isoCamPos={x:0,y:-1,z:-2};planim.baseRot.x=0;
        break;
      case 4:
        //leftstick moves unit, right stick rotates unit, 
        //lets unit strafe around for better (ranged) combat.
        //would work good with unit lockon
        o.vrot=0.01;
        planim.isoCamPos={x:0,y:-1,z:-5};planim.baseRot.x=0.5;planim.strafe=1;
        break;
    
    }
    
    uiMode=i;
    //...
  }
  //---
  init();
  this.etDebug=function(v) {
    if (v!==undefined) debug=v;
    return debug;
  }
  this.etRay0=function(v) {
    return ray0;//...
  }
  this.etFetch=function(v) {
    //if (v===null) fetch=undefined; else 
    //if (v) {
    if (arguments.length==1) {
      fetch=v;
      if (fetch) {
        fetchop.copy(fetch.position);//subVectors(fetch.position,base.position);
        fetchbp.copy(base.position);
        fetch.sc0=new THREE.Vector3(0,0,0);
        fetch.sc1=new THREE.Vector3(0,0,0);
        fetch.sc1.copy(fetch.scale);
        //console.log(fetch);
      }
    }
    return fetch;
  }
  this.etDtscale=function(v) {
    if (v!==undefined) dtscale=v;
    return dtscale;//...
  }
  this.goTo=function(ops,pos,dt) {
    var d=ops.pos.distanceTo(pos);
    if (d<(ops.v||vdef)*dt) { 
      ops.pos.copy(pos);
      ops.turnLeft=ops.turnRight=ops.goFront=false;
      return false; 
    }
    
    var da=dAng(ops.roty,angle(ops.pos,pos));
    ops.turnLeft=da<-0.1;
    ops.turnRight=da>0.1;
    ops.goFront=Math.abs(da)<0.7;
    
    //pos.sub(ops.pos);
    //vh0.subVectors(pos,ops.pos);
    //vh0.normalize();
    //vh0.multiplyScalar(dt*0.001);
    //ops.pos.add(vh0);
    return 1;
    //...
  }
  this.attackMark=function(e) {
    //later maybe add smoke here
    
    //var h=1;box(e.x,e.y+h+0.1,e.z,0.2,h*2,0.2,m1);
    //...
  }
  this.addView=addView;this.box=box;this.defaultLights=defaultLights;
  this.loadObjsThenLoop=loadObjsThenLoop;this.game=game;this.animate=animate;
  this.views=views;this.version=version;this.m0=m0;this.m1=m1;this.out=out;
  this.f4=f4;this.mray0=mray0;this.cursscale=false;this.keys=keys;
  this.loadInit=loadInit;this.rani=rani;this.outMenu=outMenu;this.initVr=initVr;
  this.pointLight=pointLight;this.vrkeys=true;this.threeEnv=threeEnv;
  this.base=base;this.updateHud=updateHud;this.vrUserHeight=0;
  this.fetchGrid=undefined;this.resize=resize;this.dAng=dAng;
  this.setTargetCampos=setTargetCampos;this.baseRot=baseRot;
  this.uiToggle=uiToggle;this.uiSet=uiSet;//this.scene=scene;
  this.defMoveAi=true;this.scriptsLoaded=[];this.startCamV=0.001;
  this.loadObj=loadObj;this.scra=scra;this.calcScra=calcScra;
  //---waypoint stuff
  var y0=-1.80,tsc=1.8*1.2,ty0=y0/tsc,mh0=new THREE.Matrix4();//,vh0=new THREE.Vector3();
  this.waypoints=[
    {x:-1*tsc,y:ty0*tsc,z:0,next:[1,3]},
    {x:2*tsc,y:(ty0+1)*tsc,z:0,next:[0,2,4]},
    {x:4*tsc,y:(ty0+1)*tsc,z:0,next:[1,5]},
    {x:-1*tsc,y:ty0*tsc,z:2*tsc,next:[0,4]},
    {x:2*tsc,y:(ty0+1)*tsc,z:2*tsc,next:[3,5,1]},
    {x:4*tsc,y:(ty0+1)*tsc,z:2*tsc,next:[4,2]},
  ];//o0,o1;
  function turnBetweenWps(o) {
    o.wppos0=self.waypoints[o.wpi];
    var owpi=o.wpi;
    o.wpi=o.wp0i;o.wp0i=owpi;
    o.wpt=o.wpmt-o.wpt;
    o.wprot+=PI;
    //...
  }
  this.waypointAi=function(dt) {
    
    //console.log('templar ai '+dt);
    //console.log('waypoints length='+waypoints.length);
    //this.ai=undefined;
    
    var o=this,vr=0.01,wantrun=false,turnleft=false,turnright=false,flee=false,fleefrom,
        startAnim=undefined,fleeing=false,waypoints=self.waypoints;
    
    if (o.ego) {
      var tsd0=self.tsd?self.tsd[0]:undefined;
      //var tsd1=self.tsd?self.tsd[1]:undefined;
      wantrun=keys[87]||(tsd0&&(tsd0.dy<-0.3));//38];
      turnleft=keys[65]||(tsd0&&(tsd0.dx<-0.3));//37];
      turnright=keys[68]||(tsd0&&(tsd0.dx>0.3));//39];
      //var cam=views[0].camera;
      //cam.rotation.set(0,0,0);
      if (wantrun&&!o.running) {
        if (o.wpt!=o.wpmt) {//wenn zwischen zwei waypoints
          //onsole.log('zwischen zwei waypoints');
          if (Math.abs(dAng(o.roty,o.wprot))>PI/2) turnBetweenWps(o);
        }
        o.running=true;
        startAnim=o.animRun;//Pd5.animStart(o.o,o.o.animh[o.animRun]);
        //calculate which waypoint based on direction
      }
      if ((keys[83]||(tsd0&&(tsd0.dy>0.3))//40]//||turnleft||turnright
        )&&o.running) {
        o.running=false;
        startAnim=o.animIdle;//Pd5.animStart(o.o,o.o.animh[o.animIdle]);
      }
    } else if (fleeing) {
      if ((o.wpi!==undefined)&&o.flee) {
        o.fleet=(o.fleet||0)+dt;
        if (o.fleet>200)
        for (var i=threeEnv.os.length-1;i>=0;i--) {
          var oh=threeEnv.os[i].ps;
          if (oh===o) continue;
          if (((oh.wpi===o.wpi)&&(oh.wp0i!==o.wp0i))||((oh.wpi===o.wp0i)&&(o.wpi===oh.wp0i))) {
            flee=true;fleefrom=oh;//console.log('ai turn!!!1');
            o.fleet=0;
          }
        }
      }
      if (o.running) {
        if (flee) turnBetweenWps(o);
      } else {
        if (flee) {
          o.running=true;wantrun=true;
          startAnim=o.animRun;//Pd5.animStart(o.o,o.o.animh[o.animRun]);
        } else {
        //o.roty=Math.random()*PI*2;
        var dr=dAng(o.waita,o.roty);
        o.roty+=dr>0?Math.min(vr*dt,dr):Math.max(-vr*dt,dr);
        o.waitt+=dt;
        if (o.waitt>=o.waitmt) { 
          if (rani(2)==0) {
            o.running=true;wantrun=true;
            startAnim=o.animRun;//Pd5.animStart(o.o,o.o.animh[o.animRun]);
          } else {
            o.waitt=0;o.waita=Math.random()*PI*2;
          } 
        }
        //var f1=o.waitt/o.waitmt,f0=;
        }
      }
    }
    
    if (//o.ego&&
      !o.running) {
      var dr=((turnleft?1:0)+(turnright?-1:0))*dt*(o.vrot||vr);
      o.roty+=dr;
    } else {
    //var nextWp=false;
    if (o.wpi===undefined) { 
      //onsole.log('anim.waypointAi wpi===undefined searching i '+o.pos.x+' '+o.pos.y+' '+o.pos.z);
      var wps=self.waypoints,mind,mini;
      for (var i=wps.length-1;i>=0;i--) {
        var wp=wps[i];if (wp.im) continue;
        var d=Vecmath.dist2(wp,o.pos);
        if (mind===undefined) { mind=d;mini=i;continue; }
        if (d>=mind) continue;
        mind=d;mini=i;
      }
      //onsole.log('anim.waypointAi wpi===undefined searching mini='+mini);
      o.wpi=mini;o.wpmt=1000;o.wpt=o.wpmt;o.wprot=o.roty; 
      if (!o.ego) wantrun=true;
      startAnim=o.animRun;//Pd5.animStart(o.o,o.o.animh[o.animRun]);
    }
    
    o.wpt+=dt;
    if (o.wpt>=o.wpmt) {
      //if (!o.ego&&fleeing) if (rani(3)==0) 
      var wp0=waypoints[o.wpi];
      if (wp0.im||!o.ego) wantrun=true;
      if (//o.ego&&
        !wantrun) {
        o.running=false;
        o.wpt=o.wpmt;
        o.waitt=0;o.waitmt=500;
        o.waita=Math.random()*PI*2;
        o.wp0i=undefined;
        startAnim=o.animIdle;//Pd5.animStart(o.o,o.o.animh[o.animIdle]);
      } else {
      //var wp0=waypoints[o.wpi];
      o.wp0i=o.wpi;
      o.wppos0=wp0;
      o.wpt=o.wpt%o.wpmt;
      
      if (o.wpRand) //choose random waypoint
        o.wpi=wp0.next[rani(wp0.next.length)];
      else {//choose waypoint in direction
        if (flee&&!o.ego) o.roty=fleefrom.roty;//Math.random()*PI*2;
        var minda=Number.MAX_VALUE;
        for (var i=0;i<wp0.next.length;i++) {
          var wp=waypoints[wp0.next[i]],dx=wp.x-wp0.x,dz=wp.z-wp0.z,
              da=Math.abs(dAng(o.roty+((turnleft?1:0)+(turnright?-1:0))*1.5
                ,-Math.atan2(dz,dx)+Math.PI/2));
          if (da<minda) { minda=da;o.wpi=wp0.next[i]; }
        }
      }
      var wp1=waypoints[o.wpi],dx=wp1.x-wp0.x,dy=wp1.y-wp0.y,dz=wp1.z-wp0.z,l=Math.sqrt(dx*dx+dy*dy+dz*dz);
      o.wpmt=Math.floor(l*500/((o.v||0.005)*200)+0.5);
      o.wpt=Math.min(o.wpt,o.wpmt);
      //o.wpt=o.wpt%o.wpmt;
      o.wprot=-Math.atan2(dz,dx)+Math.PI/2;//-+
      }
    }
    var dr=dAng(o.wprot,o.roty);//o.wprot-o.roty;//vr=0.01;
    o.roty+=dr>0?Math.min(vr*dt,dr):Math.max(-vr*dt,dr);
    if (Math.abs(dr)>1) o.wpt=Math.max(0,o.wpt-dt);//| angle too big -> no move 
    
    var pos0=o.wppos0,pos1=waypoints[o.wpi],f1=o.wpt/o.wpmt,f0=1-f1;
    o.pos.set(pos0.x*f0+pos1.x*f1,pos0.y*f0+pos1.y*f1,pos0.z*f0+pos1.z*f1);
    }
    
    if (startAnim) Pd5.animStart(o.o,o.o.animh[startAnim]);
    
    //o.roty+=dt*0.01;
    //o.pos.x=Math.random();
    if (views.length>0)
    if (views[0].vr)
    if (o.ego) {
      if (1) planim.ego=o; else {
    //  var p=o.pos;
    //  //base.position.set(-p.x,-p.y-2,-p.z-2);
    //  var m=base.matrix;
    //  //if (o.o.eyew) {
    //  //  console.log(o.o.eyew);
    //  //}
    //  vh0.set(0,0,0);
    //  //vh0.set(0,-1.75,0.15);
    //  //vh0.set(0.5,-1.75,-1);//x:0.5,z:-1 or 0.3 -0.5 or 0 0.15
    //  m.identity();m.setPosition(vh0);
    //  mh0.makeRotationY(-o.roty+Math.PI);
    //  m.multiply(mh0);
    //  if (o.o.eyew) {
    //    var p1=o.o.eyew.p1,f=o.o.scale,a=o.roty;//+o.rotofs-Math.PI;//f=350
    //    //console.log(o.o.eyew.p0);
    //    vh0.set(
    //      -p.x-(-p1.x*Math.cos(a)-p1.z*Math.sin(a))*o.scale*f
    //     ,-p.y-p1.y*o.scale*f+vrUserHeight
    //     ,-p.z+(-p1.x*Math.sin(a)+p1.z*Math.cos(a))*o.scale*f
    //     );
    //    //debug=p1.x+' '+p1.z;updateHud(views[0]);
    //    //console.log(p1.x+' '+p1.y+' '+p1.z+' '+o.scale);
    //  } else {
    //    vh0.set(-p.x,-p.y-1.75,-p.z);
    //  }  
    //  mh0.identity();mh0.setPosition(vh0);//new THREE.Vector3(-p.x,-p.y,-p.z));
    //  m.multiply(mh0);
    //  //m.identity();
    //  //m.setPosition(new THREE.Vector3(-p.x,-p.y-2,-p.z));
    //  //mh0.makeRotationY(-o.roty+Math.PI);
    //  //m.premultiply(mh0);
    //  base.matrixAutoUpdate=false;
    //  base.matrixWorldNeedsUpdate=true;
    //  //base.rotation.y=o.roty;
    //  //base.updateMatrix();
      }
    }
    
    //...
  }
  ;
  //---init menus
  (function () {
    self.mfetch={s:'fetch',r:1,actionf:function() {
      //---
      if (fetch) {
        fetch=undefined;
        out('Fetch ended.');
      } else {
        if (ray0) {
          //fetch=ray0;
          //fetchop.copy(fetch.position);//subVectors(fetch.position,base.position);
          //fetchbp.copy(base.position);
          self.etFetch(ray0);
          out('Obj fetched.');
        } else 
          out('No obj to fetch.');
      }
      //...
    }
    };
    //self.mtsd0y={checkbox:1,r:1,ms:'touch y'};
    self.mfullscreen={s:'Fullscreen',vertCenter:1,actionf:function() {
      var c=document.body;
      if (c.requestFullscreen) c.requestFullscreen();
      else if (c.mozRequestFullScreen) c.mozRequestFullScreen();
      else if (c.webkitRequestFullScreen) c.webkitRequestFullscreen();
      //---
    }
    };
    self.minitvr={s:'Init VR',actionf:initVr,vertCenter:1};
    self.muitoggle={s:'UI',actionf:uiToggle,vertCenter:1};
    self.mSwitchCam=self.megoswitch={s:'Switch cam',vertCenter:1,keys:[67],actionf:egoSwitch};//c
    self.maction={s:'\u270a'//,ms:'<br><br>Key 0'
      ,px:0.045,py:0.22,pw:0.116,ph:0.116,ydown:true,xright:true,fs:1.4};
    self.mrestart={s:'Restart',actionf:function() {
      for (var o5 of threeEnv.os) {
        var ps=o5.ps,bu=ps.backup;  
        if (!bu) continue;
        ps.pos.set(bu.x,bu.y,bu.z);
        ps.health=bu.health;
        ps.roty=bu.roty;
        delete(ps.focus);
        if (o5.bb) o5.bb.update=1;
        //---
      }
    }
    };
    
    self.mtimescale={s:'Time &times;',autoval:true,sub:[{s:'0.1'},{s:'0.5'},{s:'1'},{s:'2'},{s:'5'}],
    setfunc:function(v) {
      dtscale=parseFloat(v);
    }
    };
    
    
  }
  )();
  //---
}
var planim=new Planim();
</script></body>
</html><script>
//fr o,22
//fr o,22,19,91
//fr o,22,41
//fr o,22,45
//fr o,22,53,40
//fr o,22,53,81
//fr o,22,53,93
//fr o,22,54,7,1
//fr o,22,54,9
//fr o,22,54,9,2
//fr o,22,93
//fr o,22,93,3
//fr o,22,93,14
//fr p,25,226
